<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LogSplitter Dashboard</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Socket.IO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.2/socket.io.js"></script>
    
    <style>
        .status-card {
            transition: all 0.3s ease;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .status-active { border-left: 5px solid #28a745; }
        .status-inactive { border-left: 5px solid #dc3545; }
        .status-warning { border-left: 5px solid #ffc107; }
        
        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0;
        }
        
        .metric-label {
            color: #6c757d;
            font-size: 0.9rem;
            text-transform: uppercase;
        }
        
        .gauge-container {
            position: relative;
            width: 200px;
            height: 200px;
            margin: 0 auto;
        }
        
        .navbar-brand {
            font-weight: bold;
        }
        
        .alert-blink {
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
        
        .bg-dark-custom {
            background-color: #1a1a1a !important;
        }
        
        .text-light-custom {
            color: #f8f9fa !important;
        }
        
        .card-dark {
            background-color: #2d2d2d;
            border: 1px solid #404040;
            color: #f8f9fa;
        }
        
        body.dark-theme {
            background-color: #121212;
            color: #f8f9fa;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body class="dark-theme">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark-custom">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-industry"></i> LogSplitter Dashboard
            </a>
            <div class="navbar-nav ms-auto">
                <span class="nav-link" id="connection-status">
                    <i class="fas fa-circle text-success"></i> Connected
                </span>
                <span class="nav-link" id="last-update">
                    Last Update: --:--:--
                </span>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <!-- Alert Banner -->
        <div id="alert-banner" class="alert alert-danger alert-blink d-none" role="alert">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>CRITICAL ALERT:</strong> <span id="alert-message"></span>
        </div>

        <!-- System Status Row -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card status-card card-dark" id="estop-card">
                    <div class="card-body text-center">
                        <i class="fas fa-stop-circle fa-3x mb-3" id="estop-icon"></i>
                        <h5 class="card-title">E-STOP</h5>
                        <p class="metric-value" id="estop-status">UNKNOWN</p>
                        <p class="metric-label">Emergency Stop</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card status-card card-dark" id="engine-card">
                    <div class="card-body text-center">
                        <i class="fas fa-engine fa-3x mb-3" id="engine-icon"></i>
                        <h5 class="card-title">ENGINE</h5>
                        <p class="metric-value" id="engine-status">UNKNOWN</p>
                        <p class="metric-label">Engine Status</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card status-card card-dark" id="system-card">
                    <div class="card-body text-center">
                        <i class="fas fa-microchip fa-3x mb-3" id="system-icon"></i>
                        <h5 class="card-title">SYSTEM</h5>
                        <p class="metric-value" id="system-state">UNKNOWN</p>
                        <p class="metric-label">Current State</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card status-card card-dark">
                    <div class="card-body text-center">
                        <i class="fas fa-clock fa-3x mb-3 text-info"></i>
                        <h5 class="card-title">UPTIME</h5>
                        <p class="metric-value text-info" id="system-uptime">00:00:00</p>
                        <p class="metric-label">Controller Runtime</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Metrics Row -->
        <div class="row mb-4">
            <!-- Pressure Gauges -->
            <div class="col-md-4">
                <div class="card card-dark">
                    <div class="card-header">
                        <h5><i class="fas fa-tachometer-alt"></i> Main Pressure (A1)</h5>
                    </div>
                    <div class="card-body text-center">
                        <div style="font-size: 4rem; color: #007bff;">
                            <i class="fas fa-gauge-high"></i>
                        </div>
                        <div class="mt-3">
                            <span class="metric-value text-primary" id="pressure-a1-value">0.0</span>
                            <span class="metric-label">PSI</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card card-dark">
                    <div class="card-header">
                        <h5><i class="fas fa-tachometer-alt"></i> Filter Pressure (A5)</h5>
                    </div>
                    <div class="card-body text-center">
                        <div style="font-size: 4rem; color: #ffc107;">
                            <i class="fas fa-gauge-high"></i>
                        </div>
                        <div class="mt-3">
                            <span class="metric-value text-warning" id="pressure-a5-value">0.0</span>
                            <span class="metric-label">PSI</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fuel Volume -->
            <div class="col-md-4">
                <div class="card card-dark">
                    <div class="card-header">
                        <h5><i class="fas fa-gas-pump"></i> Fuel Volume</h5>
                    </div>
                    <div class="card-body text-center">
                        <div style="font-size: 4rem; color: #28a745;">
                            <i class="fas fa-gas-pump"></i>
                        </div>
                        <div class="mt-3">
                            <span class="metric-value text-success" id="fuel-gallons">0.0</span>
                            <span class="metric-label">Gallons</span>
                            <br>
                            <small class="text-muted" id="fuel-pounds">(0.0 lbs)</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Temperature & Monitor Status -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card card-dark">
                    <div class="card-header">
                        <h5><i class="fas fa-thermometer-half"></i> Temperature Monitoring</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6">
                                <i class="fas fa-home fa-2x text-info mb-2"></i>
                                <h4 class="metric-value text-info" id="temp-local">0.0째F</h4>
                                <p class="metric-label">Ambient</p>
                            </div>
                            <div class="col-6">
                                <i class="fas fa-fire fa-2x text-danger mb-2"></i>
                                <h4 class="metric-value text-danger" id="temp-remote">0.0째F</h4>
                                <p class="metric-label">Engine</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card card-dark">
                    <div class="card-header">
                        <h5><i class="fas fa-heartbeat"></i> Monitor Status</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="text-center">
                                    <i class="fas fa-heart fa-2x mb-2" id="heartbeat-icon"></i>
                                    <h4 class="metric-value" id="heartbeat-bpm">72</h4>
                                    <p class="metric-label">BPM Heartbeat</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="text-center">
                                    <i class="fas fa-check-circle fa-2x mb-2" id="sensors-icon"></i>
                                    <h4 class="metric-value" id="sensors-status">OK</h4>
                                    <p class="metric-label">Sensors</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row">
            <div class="col-md-6">
                <div class="card card-dark">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line"></i> Pressure Trend (Last 10 Minutes)</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="pressure-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card card-dark">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line"></i> System Stats</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-4">
                                <h3 class="metric-value text-success" id="messages-received">0</h3>
                                <p class="metric-label">Messages RX</p>
                            </div>
                            <div class="col-4">
                                <h3 class="metric-value text-primary" id="messages-written">0</h3>
                                <p class="metric-label">DB Written</p>
                            </div>
                            <div class="col-4">
                                <h3 class="metric-value text-danger" id="error-count">0</h3>
                                <p class="metric-label">Errors</p>
                            </div>
                        </div>
                        <hr>
                        <div class="text-center">
                            <small class="text-muted">
                                Started: <span id="start-time">--:--:--</span><br>
                                Rate: <span id="message-rate">0.0</span> msg/sec
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Global variables
        let socket;
        let pressureChart;
        let pressureData = { a1: [], a5: [], timestamps: [] };
        let maxDataPoints = 30; // 10 minutes at 20-second intervals
        
        // Initialize Socket.IO
        function initWebSocket() {
            socket = io();
            
            socket.on('connect', function() {
                console.log('Connected to server');
                updateConnectionStatus(true);
            });
            
            socket.on('disconnect', function() {
                console.log('Disconnected from server');
                updateConnectionStatus(false);
            });
            
            socket.on('status_update', function(data) {
                updateDashboard(data);
            });
        }
        
        // Update connection status
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connection-status');
            if (connected) {
                statusElement.innerHTML = '<i class="fas fa-circle text-success"></i> Connected';
            } else {
                statusElement.innerHTML = '<i class="fas fa-circle text-danger"></i> Disconnected';
            }
        }
        
        // Update dashboard with new data
        function updateDashboard(data) {
            console.log('Dashboard update:', data);
            
            // Update last update time
            document.getElementById('last-update').textContent = 
                'Last Update: ' + new Date().toLocaleTimeString();
            
            // Update controller status
            updateControllerStatus(data.controller);
            
            // Update monitor status
            updateMonitorStatus(data.monitor);
            
            // Update system stats
            updateSystemStats(data.system);
            
            // Update pressure chart
            updatePressureChart(data.controller);
        }
        
        // Update controller status cards
        function updateControllerStatus(controller) {
            // E-Stop Status
            const estopCard = document.getElementById('estop-card');
            const estopIcon = document.getElementById('estop-icon');
            const estopStatus = document.getElementById('estop-status');
            
            if (controller.estop_active) {
                estopCard.className = 'card status-card status-inactive card-dark';
                estopIcon.className = 'fas fa-stop-circle fa-3x mb-3 text-danger';
                estopStatus.textContent = 'ACTIVE';
                estopStatus.className = 'metric-value text-danger';
                showAlert('E-STOP ACTIVATED - System Halted');
            } else {
                estopCard.className = 'card status-card status-active card-dark';
                estopIcon.className = 'fas fa-play-circle fa-3x mb-3 text-success';
                estopStatus.textContent = 'CLEAR';
                estopStatus.className = 'metric-value text-success';
                hideAlert();
            }
            
            // Engine Status
            const engineCard = document.getElementById('engine-card');
            const engineIcon = document.getElementById('engine-icon');
            const engineStatus = document.getElementById('engine-status');
            
            if (controller.engine_running) {
                engineCard.className = 'card status-card status-active card-dark';
                engineIcon.className = 'fas fa-play fa-3x mb-3 text-success';
                engineStatus.textContent = 'RUNNING';
                engineStatus.className = 'metric-value text-success';
            } else {
                engineCard.className = 'card status-card status-inactive card-dark';
                engineIcon.className = 'fas fa-stop fa-3x mb-3 text-danger';
                engineStatus.textContent = 'STOPPED';
                engineStatus.className = 'metric-value text-danger';
            }
            
            // System State
            const systemState = document.getElementById('system-state');
            systemState.textContent = controller.current_state || 'UNKNOWN';
            
            // Uptime
            const uptime = document.getElementById('system-uptime');
            uptime.textContent = formatUptime(controller.uptime_seconds);
            
            // Pressure Values
            document.getElementById('pressure-a1-value').textContent = controller.pressure_a1.toFixed(1);
            document.getElementById('pressure-a5-value').textContent = controller.pressure_a5.toFixed(1);
        }
        
        // Update monitor status
        function updateMonitorStatus(monitor) {
            // Fuel Volume
            document.getElementById('fuel-gallons').textContent = monitor.fuel_gallons.toFixed(1);
            document.getElementById('fuel-pounds').textContent = `(${monitor.fuel_pounds.toFixed(1)} lbs)`;
            
            // Temperature
            document.getElementById('temp-local').textContent = `${monitor.temp_local.toFixed(1)}째F`;
            document.getElementById('temp-remote').textContent = `${monitor.temp_remote.toFixed(1)}째F`;
            
            // Heartbeat
            const heartbeatIcon = document.getElementById('heartbeat-icon');
            const heartbeatBpm = document.getElementById('heartbeat-bpm');
            
            heartbeatBpm.textContent = monitor.heartbeat_bpm || 72;
            
            if (monitor.heartbeat_active) {
                heartbeatIcon.className = 'fas fa-heart fa-2x mb-2 text-danger';
                heartbeatIcon.style.animation = 'pulse 1s infinite';
            } else {
                heartbeatIcon.className = 'fas fa-heart fa-2x mb-2 text-muted';
                heartbeatIcon.style.animation = 'none';
            }
            
            // Sensors Status
            const sensorsIcon = document.getElementById('sensors-icon');
            const sensorsStatus = document.getElementById('sensors-status');
            
            if (monitor.sensors_ok) {
                sensorsIcon.className = 'fas fa-check-circle fa-2x mb-2 text-success';
                sensorsStatus.textContent = 'OK';
                sensorsStatus.className = 'metric-value text-success';
            } else {
                sensorsIcon.className = 'fas fa-times-circle fa-2x mb-2 text-danger';
                sensorsStatus.textContent = 'ERROR';
                sensorsStatus.className = 'metric-value text-danger';
            }
        }
        
        // Update system statistics
        function updateSystemStats(system) {
            document.getElementById('messages-received').textContent = system.messages_received || 0;
            document.getElementById('messages-written').textContent = system.messages_written || 0;
            document.getElementById('error-count').textContent = system.errors || 0;
            
            if (system.start_time) {
                const startTime = new Date(system.start_time);
                document.getElementById('start-time').textContent = startTime.toLocaleTimeString();
            }
            
            // Calculate message rate
            const uptime = system.uptime_seconds || 1;
            const rate = (system.messages_received || 0) / uptime;
            document.getElementById('message-rate').textContent = rate.toFixed(1);
        }
        
        // Update pressure chart
        function updatePressureChart(controller) {
            const now = new Date();
            
            // Add new data points
            pressureData.timestamps.push(now.toLocaleTimeString());
            pressureData.a1.push(controller.pressure_a1 || 0);
            pressureData.a5.push(controller.pressure_a5 || 0);
            
            // Remove old data points
            if (pressureData.timestamps.length > maxDataPoints) {
                pressureData.timestamps.shift();
                pressureData.a1.shift();
                pressureData.a5.shift();
            }
            
            // Update chart
            if (pressureChart) {
                pressureChart.data.labels = pressureData.timestamps;
                pressureChart.data.datasets[0].data = pressureData.a1;
                pressureChart.data.datasets[1].data = pressureData.a5;
                pressureChart.update('none');
            }
        }
        
        // Initialize pressure chart
        function initPressureChart() {
            const ctx = document.getElementById('pressure-chart').getContext('2d');
            pressureChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Main Pressure (A1)',
                        data: [],
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        tension: 0.4,
                        fill: false
                    }, {
                        label: 'Filter Pressure (A5)',
                        data: [],
                        borderColor: '#ffc107',
                        backgroundColor: 'rgba(255, 193, 7, 0.1)',
                        tension: 0.4,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 3000,
                            grid: { color: '#404040' },
                            ticks: { color: '#f8f9fa' }
                        },
                        x: {
                            grid: { color: '#404040' },
                            ticks: { color: '#f8f9fa' }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#f8f9fa' }
                        }
                    }
                }
            });
        }
        
        // Utility functions
        function formatUptime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        
        function showAlert(message) {
            document.getElementById('alert-message').textContent = message;
            document.getElementById('alert-banner').classList.remove('d-none');
        }
        
        function hideAlert() {
            document.getElementById('alert-banner').classList.add('d-none');
        }
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initWebSocket();
            initPressureChart();
            
            // Fetch initial data
            fetch('/api/status')
                .then(response => response.json())
                .then(data => updateDashboard(data))
                .catch(error => console.error('Error fetching initial data:', error));
        });
    </script>
</body>
</html>