<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LogSplitter Protobuf Dashboard</title>
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }
        
        .header-title {
            font-size: 2.5em;
            font-weight: 300;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .status-badge {
            display: inline-block;
            padding: 8px 16px;
            background: rgba(76, 175, 80, 0.9);
            color: white;
            border-radius: 20px;
            font-size: 0.9em;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .stat-card {
            text-align: center;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .card-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #444;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }
        
        .message-list {
            max-height: 400px;
            overflow-y: auto;
            border-radius: 8px;
            background: rgba(248, 249, 250, 0.8);
            padding: 10px;
        }
        
        .message-item {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .message-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .message-type {
            font-weight: bold;
            color: #667eea;
        }
        
        .message-timestamp {
            color: #666;
            font-size: 0.8em;
        }
        
        .message-details {
            font-size: 0.9em;
            color: #555;
        }
        
        .payload-item {
            background: rgba(102, 126, 234, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            margin: 2px;
            display: inline-block;
            font-size: 0.8em;
        }
        
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        .stats-table th,
        .stats-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .stats-table th {
            background: rgba(102, 126, 234, 0.1);
            font-weight: 600;
            color: #444;
        }
        
        .stats-table tr:hover {
            background: rgba(102, 126, 234, 0.05);
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 15px;
        }
        
        .full-width {
            grid-column: 1 / -1;
        }
        
        .refresh-indicator {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(76, 175, 80, 0.9);
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            z-index: 1000;
            animation: fadeInOut 2s ease-in-out;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-20px); }
            50% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        
        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8em;
            z-index: 1000;
        }
        
        /* Navigation Tabs */
        .dashboard-nav {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            gap: 10px;
        }
        
        .nav-tab {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .nav-tab:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .nav-tab.active {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Analytics Specific Styles */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .analytics-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        
        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .metric-row:last-child {
            border-bottom: none;
        }
        
        .metric-label {
            color: #666;
            font-size: 0.9em;
        }
        
        .metric-value {
            font-weight: bold;
            color: #333;
        }
        
        .metric-value.success {
            color: #4CAF50;
        }
        
        .metric-value.warning {
            color: #FF9800;
        }
        
        .metric-value.error {
            color: #F44336;
        }
        
        .health-score {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .health-bar {
            flex: 1;
            height: 8px;
            background: #eee;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .health-fill {
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .health-excellent {
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
        }
        
        .health-good {
            background: linear-gradient(90deg, #8BC34A, #CDDC39);
        }
        
        .health-warning {
            background: linear-gradient(90deg, #CDDC39, #FF9800);
        }
        
        .health-poor {
            background: linear-gradient(90deg, #FF9800, #F44336);
        }
        
        .connected {
            background: rgba(76, 175, 80, 0.9);
            color: white;
        }
        
        .disconnected {
            background: rgba(244, 67, 54, 0.9);
            color: white;
        }
        
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .overview-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .header-title {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1 class="header-title">LogSplitter Protobuf Dashboard</h1>
            <div class="status-badge" id="systemStatus">🟢 System Online</div>
        </header>
        
        <!-- Navigation Tabs -->
        <nav class="dashboard-nav">
            <button class="nav-tab active" onclick="switchTab('overview')">📊 Overview</button>
            <button class="nav-tab" onclick="switchTab('analytics')">📈 Analytics</button>
            <button class="nav-tab" onclick="switchTab('realtime')">📡 Real-time</button>
        </nav>
        
        <!-- Overview Tab -->
        <div id="overview-tab" class="tab-content active">
            <!-- System Overview -->
            <div class="overview-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalMessages">0</div>
                    <div class="stat-label">Total Messages</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="messagesLastHour">0</div>
                    <div class="stat-label">Last Hour</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="databaseSize">0 MB</div>
                    <div class="stat-label">Database Size</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="uniqueTypes">0</div>
                    <div class="stat-label">Message Types</div>
                </div>
            </div>
            
            <!-- Message Type Statistics -->
            <div class="card full-width">
                <h2 class="card-title">📊 Message Type Breakdown</h2>
                <table class="stats-table" id="messageTypeStats">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Count</th>
                            <th>Avg Size</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="3" style="text-align: center; color: #666;">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Analytics Tab -->
        <div id="analytics-tab" class="tab-content">
            <!-- Analytics Overview Cards -->
            <div class="overview-grid">
                <div class="stat-card">
                    <div class="stat-value" id="cyclesCompleted">0</div>
                    <div class="stat-label">Cycles Completed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="basketExchanges">0</div>
                    <div class="stat-label">🧺 Basket Exchanges</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="successRate">0%</div>
                    <div class="stat-label">Success Rate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgCycleTime">0s</div>
                    <div class="stat-label">Avg Cycle Time</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="basketEfficiency">100%</div>
                    <div class="stat-label">🧺 Exchange Efficiency</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="overallHealth">0%</div>
                    <div class="stat-label">System Health</div>
                </div>
            </div>
            
            <!-- Metrics Grid -->
            <div class="metrics-grid">
                <!-- Cycle Analysis -->
                <div class="analytics-card">
                    <h3 class="card-title">🔄 Cycle Analysis</h3>
                    <div id="cycleMetrics">
                        <div class="metric-row">
                            <span class="metric-label">Total Cycles</span>
                            <span class="metric-value" id="totalCycles">0</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Completed</span>
                            <span class="metric-value success" id="completedCycles">0</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Short Strokes</span>
                            <span class="metric-value warning" id="shortStrokes">0</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Success Rate</span>
                            <span class="metric-value" id="cycleSuccessRate">0%</span>
                        </div>
                    </div>
                </div>
                
                <!-- Pressure Analysis -->
                <div class="analytics-card">
                    <h3 class="card-title">⚡ Pressure Analysis</h3>
                    <div id="pressureMetrics">
                        <div class="metric-row">
                            <span class="metric-label">Max Pressure</span>
                            <span class="metric-value" id="maxPressure">0 PSI</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Avg Pressure</span>
                            <span class="metric-value" id="avgPressure">0 PSI</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Pressure Spikes</span>
                            <span class="metric-value warning" id="pressureSpikes">0</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Pressure Faults</span>
                            <span class="metric-value error" id="pressureFaults">0</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Efficiency</span>
                            <span class="metric-value" id="pressureEfficiency">0%</span>
                        </div>
                    </div>
                </div>
                
                <!-- Operational Efficiency -->
                <div class="analytics-card">
                    <h3 class="card-title">⚙️ Operational Efficiency</h3>
                    <div id="efficiencyMetrics">
                        <div class="metric-row">
                            <span class="metric-label">Extend Operations</span>
                            <span class="metric-value" id="extendOps">0</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Retract Operations</span>
                            <span class="metric-value" id="retractOps">0</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Manual Operations</span>
                            <span class="metric-value warning" id="manualOps">0</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Auto Operations</span>
                            <span class="metric-value success" id="autoOps">0</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Automation Ratio</span>
                            <span class="metric-value" id="automationRatio">0%</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Uptime</span>
                            <span class="metric-value" id="uptime">0 min</span>
                        </div>
                    </div>
                </div>
                
                <!-- Safety Analysis -->
                <div class="analytics-card">
                    <h3 class="card-title">🛡️ Safety Analysis</h3>
                    <div id="safetyMetrics">
                        <div class="metric-row">
                            <span class="metric-label">Safety Activations</span>
                            <span class="metric-value warning" id="safetyActivations">0</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Emergency Stops</span>
                            <span class="metric-value error" id="emergencyStops">0</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Limit Triggers</span>
                            <span class="metric-value" id="limitTriggers">0</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Pressure Safeties</span>
                            <span class="metric-value warning" id="pressureSafeties">0</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Safety Score</span>
                            <span class="metric-value" id="safetyScore">100%</span>
                        </div>
                    </div>
                </div>
                
                <!-- System Health -->
                <div class="analytics-card">
                    <h3 class="card-title">💻 System Health</h3>
                    <div id="healthMetrics">
                        <div class="metric-row">
                            <span class="metric-label">Memory Health</span>
                            <div class="health-score">
                                <div class="health-bar">
                                    <div class="health-fill health-excellent" id="memoryHealthBar" style="width: 0%"></div>
                                </div>
                                <span class="metric-value" id="memoryHealth">0%</span>
                            </div>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Performance</span>
                            <div class="health-score">
                                <div class="health-bar">
                                    <div class="health-fill health-good" id="performanceBar" style="width: 0%"></div>
                                </div>
                                <span class="metric-value" id="performance">0%</span>
                            </div>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Error Rate</span>
                            <div class="health-score">
                                <div class="health-bar">
                                    <div class="health-fill health-warning" id="errorBar" style="width: 0%"></div>
                                </div>
                                <span class="metric-value" id="errorRate">0%</span>
                            </div>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Overall Health</span>
                            <div class="health-score">
                                <div class="health-bar">
                                    <div class="health-fill health-excellent" id="overallHealthBar" style="width: 0%"></div>
                                </div>
                                <span class="metric-value" id="overallHealthScore">0%</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Operational Patterns -->
                <div class="analytics-card">
                    <h3 class="card-title">📅 Operational Patterns</h3>
                    <div id="patternMetrics">
                        <div class="metric-row">
                            <span class="metric-label">Peak Hour</span>
                            <span class="metric-value" id="peakHour">--:--</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Peak Activity</span>
                            <span class="metric-value" id="peakActivity">0</span>
                        </div>
                    </div>
                    <div class="chart-container" style="height: 200px;">
                        <canvas id="patternsChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Performance Charts -->
            <div class="card full-width">
                <h2 class="card-title">📈 Performance Trends</h2>
                <div class="chart-container">
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Real-time Tab -->
        <div id="realtime-tab" class="tab-content">
            <!-- Main Dashboard -->
            <div class="dashboard-grid">
                <!-- Real-time Messages -->
                <div class="card">
                    <h2 class="card-title">📡 Real-time Messages</h2>
                    <div class="message-list" id="messageList">
                        <div style="text-align: center; color: #666; padding: 20px;">
                            Waiting for protobuf messages...
                        </div>
                    </div>
                </div>
                
                <!-- Activity Chart -->
                <div class="card">
                    <h2 class="card-title">📈 Message Activity (24 Hours)</h2>
                    <div class="chart-container">
                        <canvas id="activityChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Status Indicators -->
    <div class="refresh-indicator" id="refreshIndicator">
        📡 New data received
    </div>
    
    <div class="connection-status connected" id="connectionStatus">
        🔗 Connected
    </div>
    
    <script>
        // Socket.IO connection
        const socket = io();
        
        // Chart instances
        let activityChart = null;
        let patternsChart = null;
        let performanceChart = null;
        
        // Connection status handling
        socket.on('connect', function() {
            console.log('Connected to dashboard');
            document.getElementById('connectionStatus').className = 'connection-status connected';
            document.getElementById('connectionStatus').innerHTML = '🔗 Connected';
        });
        
        socket.on('disconnect', function() {
            console.log('Disconnected from dashboard');
            document.getElementById('connectionStatus').className = 'connection-status disconnected';
            document.getElementById('connectionStatus').innerHTML = '❌ Disconnected';
        });
        
        // Real-time message updates
        socket.on('new_messages', function(data) {
            updateOverview(data.overview);
            updateMessageList(data.messages);
            showRefreshIndicator();
        });
        
        // Update system overview
        function updateOverview(overview) {
            document.getElementById('totalMessages').textContent = overview.total_messages.toLocaleString();
            document.getElementById('messagesLastHour').textContent = overview.messages_last_hour.toLocaleString();
            document.getElementById('databaseSize').textContent = overview.database_size_mb + ' MB';
            document.getElementById('uniqueTypes').textContent = overview.unique_types;
        }
        
        // Update message list
        function updateMessageList(messages) {
            const messageList = document.getElementById('messageList');
            
            // Keep only the first 20 messages for performance
            const displayMessages = messages.slice(0, 20);
            
            messageList.innerHTML = displayMessages.map(message => {
                const timestamp = new Date(message.received_timestamp).toLocaleTimeString();
                const payloadItems = Object.entries(message.payload).map(([key, value]) => 
                    `<span class="payload-item">${key}: ${value}</span>`
                ).join(' ');
                
                return `
                    <div class="message-item">
                        <div class="message-header">
                            <span class="message-type">${message.message_type_name} (${message.message_type})</span>
                            <span class="message-timestamp">${timestamp}</span>
                        </div>
                        <div class="message-details">
                            Seq: ${message.sequence_id} | Size: ${message.raw_size}B
                            <div style="margin-top: 5px;">${payloadItems}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Show refresh indicator
        function showRefreshIndicator() {
            const indicator = document.getElementById('refreshIndicator');
            indicator.style.display = 'block';
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 2000);
        }
        
        // Load initial data
        async function loadInitialData() {
            try {
                // Load overview
                const overviewResponse = await fetch('/api/overview');
                const overview = await overviewResponse.json();
                updateOverview(overview);
                
                // Load recent messages
                const messagesResponse = await fetch('/api/recent?limit=20');
                const messages = await messagesResponse.json();
                updateMessageList(messages);
                
                // Load message type stats
                const statsResponse = await fetch('/api/stats');
                const stats = await statsResponse.json();
                updateMessageTypeStats(stats);
                
                // Load activity chart
                const activityResponse = await fetch('/api/activity');
                const activity = await activityResponse.json();
                createActivityChart(activity);
                
            } catch (error) {
                console.error('Error loading initial data:', error);
            }
        }
        
        // Update message type statistics table
        function updateMessageTypeStats(stats) {
            const tbody = document.querySelector('#messageTypeStats tbody');
            
            if (stats.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #666;">No data available</td></tr>';
                return;
            }
            
            tbody.innerHTML = stats.map(stat => `
                <tr>
                    <td>
                        <strong>${stat.type_name}</strong><br>
                        <small style="color: #666;">${stat.type_id}</small>
                    </td>
                    <td>${stat.count.toLocaleString()}</td>
                    <td>${stat.avg_size} B</td>
                </tr>
            `).join('');
        }
        
        // Create activity chart
        function createActivityChart(activityData) {
            const ctx = document.getElementById('activityChart').getContext('2d');
            
            // Process data for Chart.js
            const hours = Object.keys(activityData).sort();
            const messageTypes = new Set();
            
            // Get all unique message types
            Object.values(activityData).forEach(hourData => {
                Object.keys(hourData).forEach(type => messageTypes.add(type));
            });
            
            const datasets = Array.from(messageTypes).map((type, index) => {
                const colors = ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#00f2fe'];
                const color = colors[index % colors.length];
                
                return {
                    label: type,
                    data: hours.map(hour => activityData[hour][type] || 0),
                    borderColor: color,
                    backgroundColor: color + '20',
                    tension: 0.4,
                    fill: false
                };
            });
            
            if (activityChart) {
                activityChart.destroy();
            }
            
            activityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: hours.map(hour => new Date(hour).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Message Activity Over Time'
                        },
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Messages per Hour'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        }
                    }
                }
            });
        }
        
        // Tab switching functionality
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Mark nav tab as active
            event.target.classList.add('active');
            
            // Load tab-specific data
            if (tabName === 'analytics') {
                loadAnalyticsData();
            }
        }
        
        // Load analytics data
        async function loadAnalyticsData() {
            try {
                const response = await fetch('/api/analytics');
                const analytics = await response.json();
                updateAnalytics(analytics);
                
                // Load basket metrics
                const basketResponse = await fetch('/api/basket');
                const basketMetrics = await basketResponse.json();
                updateBasketMetrics(basketMetrics);
            } catch (error) {
                console.error('Error loading analytics data:', error);
            }
        }
        
        // Update analytics display
        function updateAnalytics(analytics) {
            // Update overview cards
            if (analytics.cycle_analysis) {
                document.getElementById('cyclesCompleted').textContent = analytics.cycle_analysis.cycles_completed;
                document.getElementById('successRate').textContent = analytics.cycle_analysis.success_rate + '%';
                document.getElementById('avgCycleTime').textContent = analytics.cycle_analysis.avg_cycle_time_sec + 's';
            }
            
            if (analytics.system_health) {
                document.getElementById('overallHealth').textContent = analytics.system_health.overall_health_score + '%';
            }
            
            // Update cycle metrics
            if (analytics.cycle_analysis) {
                document.getElementById('totalCycles').textContent = analytics.cycle_analysis.total_cycles;
                document.getElementById('completedCycles').textContent = analytics.cycle_analysis.cycles_completed;
                document.getElementById('shortStrokes').textContent = analytics.cycle_analysis.short_strokes;
                document.getElementById('cycleSuccessRate').textContent = analytics.cycle_analysis.success_rate + '%';
            }
            
            // Update pressure metrics
            if (analytics.pressure_analysis) {
                document.getElementById('maxPressure').textContent = analytics.pressure_analysis.max_pressure_psi + ' PSI';
                document.getElementById('avgPressure').textContent = analytics.pressure_analysis.avg_pressure_psi + ' PSI';
                document.getElementById('pressureSpikes').textContent = analytics.pressure_analysis.pressure_spikes;
                document.getElementById('pressureFaults').textContent = analytics.pressure_analysis.pressure_faults;
                document.getElementById('pressureEfficiency').textContent = analytics.pressure_analysis.pressure_efficiency + '%';
            }
            
            // Update efficiency metrics
            if (analytics.efficiency_metrics) {
                document.getElementById('extendOps').textContent = analytics.efficiency_metrics.extend_operations;
                document.getElementById('retractOps').textContent = analytics.efficiency_metrics.retract_operations;
                document.getElementById('manualOps').textContent = analytics.efficiency_metrics.manual_operations;
                document.getElementById('autoOps').textContent = analytics.efficiency_metrics.auto_operations;
                document.getElementById('automationRatio').textContent = analytics.efficiency_metrics.automation_ratio + '%';
                document.getElementById('uptime').textContent = analytics.efficiency_metrics.uptime_minutes + ' min';
            }
            
            // Update safety metrics
            if (analytics.safety_analysis) {
                document.getElementById('safetyActivations').textContent = analytics.safety_analysis.safety_activations;
                document.getElementById('emergencyStops').textContent = analytics.safety_analysis.emergency_stops;
                document.getElementById('limitTriggers').textContent = analytics.safety_analysis.limit_triggers;
                document.getElementById('pressureSafeties').textContent = analytics.safety_analysis.pressure_safeties;
                document.getElementById('safetyScore').textContent = analytics.safety_analysis.safety_score + '%';
            }
            
            // Update system health metrics with bars
            if (analytics.system_health) {
                updateHealthBar('memoryHealthBar', 'memoryHealth', analytics.system_health.memory_health_score);
                updateHealthBar('performanceBar', 'performance', analytics.system_health.performance_score);
                updateHealthBar('errorBar', 'errorRate', analytics.system_health.error_score);
                updateHealthBar('overallHealthBar', 'overallHealthScore', analytics.system_health.overall_health_score);
            }
            
            // Update operational patterns
            if (analytics.operational_patterns) {
                document.getElementById('peakHour').textContent = analytics.operational_patterns.peak_hour + ':00';
                document.getElementById('peakActivity').textContent = analytics.operational_patterns.peak_activity;
                
                // Create patterns chart
                createPatternsChart(analytics.operational_patterns.hourly_activity);
            }
            
            // Create performance trends chart
            if (analytics.cycle_analysis && analytics.pressure_analysis) {
                createPerformanceChart(analytics);
            }
        }
        
        // Update health bars
        function updateHealthBar(barId, valueId, score) {
            const bar = document.getElementById(barId);
            const valueEl = document.getElementById(valueId);
            
            bar.style.width = score + '%';
            valueEl.textContent = Math.round(score) + '%';
            
            // Update bar color based on score
            bar.className = 'health-fill';
            if (score >= 80) {
                bar.classList.add('health-excellent');
            } else if (score >= 60) {
                bar.classList.add('health-good');
            } else if (score >= 40) {
                bar.classList.add('health-warning');
            } else {
                bar.classList.add('health-poor');
            }
        }
        
        // Create patterns chart
        function createPatternsChart(hourlyData) {
            const ctx = document.getElementById('patternsChart').getContext('2d');
            
            const hours = Array.from({length: 24}, (_, i) => i);
            const data = hours.map(hour => hourlyData[hour] || 0);
            
            if (patternsChart) {
                patternsChart.destroy();
            }
            
            patternsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: hours.map(h => h + ':00'),
                    datasets: [{
                        label: 'Activity Level',
                        data: data,
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: '#667eea',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Messages'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Hour of Day'
                            }
                        }
                    }
                }
            });
        }
        
        // Create performance trends chart
        function createPerformanceChart(analytics) {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            
            // Generate sample data points (in real implementation, this would come from time-series data)
            const timePoints = Array.from({length: 10}, (_, i) => `T-${9-i}`);
            
            const datasets = [
                {
                    label: 'Success Rate (%)',
                    data: Array.from({length: 10}, () => 
                        Math.max(0, analytics.cycle_analysis.success_rate + (Math.random() - 0.5) * 20)
                    ),
                    borderColor: '#4CAF50',
                    backgroundColor: 'rgba(76, 175, 80, 0.1)',
                    yAxisID: 'y'
                },
                {
                    label: 'Avg Cycle Time (s)',
                    data: Array.from({length: 10}, () => 
                        Math.max(5, analytics.cycle_analysis.avg_cycle_time_sec + (Math.random() - 0.5) * 10)
                    ),
                    borderColor: '#2196F3',
                    backgroundColor: 'rgba(33, 150, 243, 0.1)',
                    yAxisID: 'y1'
                },
                {
                    label: 'System Health (%)',
                    data: Array.from({length: 10}, () => 
                        Math.max(0, analytics.system_health.overall_health_score + (Math.random() - 0.5) * 15)
                    ),
                    borderColor: '#FF9800',
                    backgroundColor: 'rgba(255, 152, 0, 0.1)',
                    yAxisID: 'y'
                }
            ];
            
            if (performanceChart) {
                performanceChart.destroy();
            }
            
            performanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timePoints,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Time Period'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Percentage (%)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Time (seconds)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Performance Trends Over Time'
                        }
                    }
                }
            });
        }
        
        // Update basket metrics display
        function updateBasketMetrics(basket) {
            // Update overview cards only
            document.getElementById('basketExchanges').textContent = basket.total_exchanges || 0;
            document.getElementById('basketEfficiency').textContent = basket.avg_efficiency_score + '%';
        }
        
        // Load initial data when page loads
        document.addEventListener('DOMContentLoaded', loadInitialData);
        
        // Refresh data periodically
        setInterval(async () => {
            try {
                const overviewResponse = await fetch('/api/overview');
                const overview = await overviewResponse.json();
                updateOverview(overview);
                
                const statsResponse = await fetch('/api/stats');
                const stats = await statsResponse.json();
                updateMessageTypeStats(stats);
                
                // Refresh analytics if on analytics tab
                const analyticsTab = document.getElementById('analytics-tab');
                if (analyticsTab.classList.contains('active')) {
                    loadAnalyticsData();
                }
                
            } catch (error) {
                console.error('Error refreshing data:', error);
            }
        }, 30000); // Refresh every 30 seconds
        
    </script>
</body>
</html>