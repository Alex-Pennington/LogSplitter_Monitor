<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LogSplitter Control Dashboard</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <!-- Socket.IO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    
    <style>
        .status-card {
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .status-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        
        .status-ok { border-left: 5px solid #28a745; }
        .status-warning { border-left: 5px solid #ffc107; }  
        .status-danger { border-left: 5px solid #dc3545; }
        
        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 0;
        }
        
        .metric-label {
            font-size: 0.9rem;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .gauge-container {
            height: 300px;
            margin: 20px 0;
        }
        
        .chart-container {
            height: 400px;
            margin: 20px 0;
        }
        
        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }
        
        .estop-active {
            background: linear-gradient(45deg, #ff0000, #cc0000);
            color: white;
            animation: pulse 1s infinite;
        }
        
        .engine-running {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
        }
        
        .engine-stopped {
            background: linear-gradient(45deg, #6c757d, #495057);
            color: white;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .alert-ticker {
            background: #1a1a1a;
            color: #fff;
            padding: 10px;
            overflow: hidden;
            white-space: nowrap;
        }
        
        .alert-scroll {
            display: inline-block;
            animation: scroll-left 30s linear infinite;
        }
        
        @keyframes scroll-left {
            0% { transform: translate3d(100%, 0, 0); }
            100% { transform: translate3d(-100%, 0, 0); }
        }
        
        .fuel-gauge-container {
            position: relative;
            height: 250px;
        }
        
        .fuel-level {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            background: linear-gradient(to top, #ff6b35, #f7931e, #ffc107);
            border-radius: 30px 30px 5px 5px;
            border: 3px solid #333;
            transition: height 0.5s ease;
        }
        
        .fuel-tank {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 66px;
            height: 200px;
            border: 3px solid #333;
            border-radius: 33px 33px 5px 5px;
            background: rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fas fa-cogs"></i> LogSplitter Control Dashboard
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/safety">
                    <i class="fas fa-shield-alt"></i> Safety
                </a>
                <a class="nav-link" href="/fuel">
                    <i class="fas fa-gas-pump"></i> Fuel
                </a>
                <a class="nav-link" href="/system">
                    <i class="fas fa-server"></i> System
                </a>
            </div>
        </div>
    </nav>

    <!-- Alert Ticker -->
    <div class="alert-ticker" id="alertTicker" style="display: none;">
        <div class="alert-scroll" id="alertText">
            System Alert: Monitoring active
        </div>
    </div>

    <!-- Main Dashboard -->
    <div class="container-fluid mt-4">
        <!-- System Status Row -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card status-card" id="estopCard">
                    <div class="card-body text-center">
                        <i class="fas fa-hand-paper fa-3x mb-3" id="estopIcon"></i>
                        <h5 class="card-title">E-STOP STATUS</h5>
                        <p class="metric-value" id="estopStatus">UNKNOWN</p>
                        <p class="metric-label">Emergency Stop</p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="card status-card" id="engineCard">
                    <div class="card-body text-center">
                        <i class="fas fa-engine fa-3x mb-3" id="engineIcon"></i>
                        <h5 class="card-title">ENGINE STATUS</h5>
                        <p class="metric-value" id="engineStatus">UNKNOWN</p>
                        <p class="metric-label">Engine State</p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="card status-card status-ok">
                    <div class="card-body text-center">
                        <i class="fas fa-tachometer-alt fa-3x mb-3 text-info"></i>
                        <h5 class="card-title">SEQUENCE STATE</h5>
                        <p class="metric-value" id="sequenceState">IDLE</p>
                        <p class="metric-label">Current Operation</p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="card status-card status-ok">
                    <div class="card-body text-center">
                        <i class="fas fa-clock fa-3x mb-3 text-success"></i>
                        <h5 class="card-title">SYSTEM UPTIME</h5>
                        <p class="metric-value" id="systemUptime">0s</p>
                        <p class="metric-label">Controller Online</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pressure and Fuel Row -->
        <div class="row mb-4">
            <!-- Pressure Gauges -->
            <div class="col-md-4">
                <div class="card status-card">
                    <div class="card-header">
                        <h5><i class="fas fa-gauge-high"></i> Main Pressure (A1)</h5>
                    </div>
                    <div class="card-body">
                        <div id="pressureA1Gauge" class="gauge-container"></div>
                        <div class="text-center">
                            <span class="metric-value text-primary" id="pressureA1Value">0</span>
                            <span class="metric-label">PSI</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card status-card">
                    <div class="card-header">
                        <h5><i class="fas fa-gauge"></i> Filter Pressure (A5)</h5>
                    </div>
                    <div class="card-body">
                        <div id="pressureA5Gauge" class="gauge-container"></div>
                        <div class="text-center">
                            <span class="metric-value text-info" id="pressureA5Value">0</span>
                            <span class="metric-label">PSI</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fuel Tank Visual -->
            <div class="col-md-4">
                <div class="card status-card">
                    <div class="card-header">
                        <h5><i class="fas fa-gas-pump"></i> Fuel Level</h5>
                    </div>
                    <div class="card-body">
                        <div class="fuel-gauge-container">
                            <div class="fuel-tank"></div>
                            <div class="fuel-level" id="fuelLevel" style="height: 0%;"></div>
                        </div>
                        <div class="text-center mt-3">
                            <div>
                                <span class="metric-value text-warning" id="fuelGallons">0</span>
                                <span class="metric-label">GALLONS</span>
                            </div>
                            <div>
                                <span class="badge bg-info" id="fuelPercent">0%</span>
                                <span class="badge bg-secondary" id="fuelPounds">0 lbs</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card status-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-chart-line"></i> Pressure History</h5>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-primary" onclick="loadPressureChart(1)">1h</button>
                            <button type="button" class="btn btn-primary" onclick="loadPressureChart(6)">6h</button>
                            <button type="button" class="btn btn-outline-primary" onclick="loadPressureChart(24)">24h</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="pressureChart" class="chart-container"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card status-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-chart-area"></i> Fuel Volume History</h5>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-warning" onclick="loadFuelChart(6)">6h</button>
                            <button type="button" class="btn btn-warning" onclick="loadFuelChart(24)">24h</button>
                            <button type="button" class="btn btn-outline-warning" onclick="loadFuelChart(168)">7d</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="fuelChart" class="chart-container"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Temperature and Events Row -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card status-card">
                    <div class="card-header">
                        <h5><i class="fas fa-thermometer-half"></i> Temperature Monitoring</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6 text-center">
                                <h6>Local/Ambient</h6>
                                <span class="metric-value text-info" id="tempLocal">0</span>
                                <span class="metric-label">Â°F</span>
                            </div>
                            <div class="col-6 text-center">
                                <h6>Remote/Engine</h6>
                                <span class="metric-value text-danger" id="tempRemote">0</span>
                                <span class="metric-label">Â°F</span>
                            </div>
                        </div>
                        <div id="temperatureChart" class="chart-container"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card status-card">
                    <div class="card-header">
                        <h5><i class="fas fa-list"></i> Recent Events</h5>
                    </div>
                    <div class="card-body">
                        <div id="eventLog" style="max-height: 350px; overflow-y: auto;">
                            <p class="text-muted">Loading events...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Initialize Socket.IO connection
        const socket = io();
        
        // Global data storage
        let currentData = {
            controller: {},
            monitor: {},
            alerts: []
        };
        
        // Socket event handlers
        socket.on('connect', function() {
            console.log('Connected to LogSplitter dashboard');
            updateConnectionStatus(true);
        });
        
        socket.on('disconnect', function() {
            console.log('Disconnected from dashboard');
            updateConnectionStatus(false);
        });
        
        socket.on('status_update', function(data) {
            currentData = data;
            updateDashboard(data);
        });
        
        socket.on('alert', function(alert) {
            showAlert(alert);
        });
        
        socket.on('chart_data', function(data) {
            if (data.type === 'pressure') {
                updatePressureChart(data.data);
            } else if (data.type === 'fuel') {
                updateFuelChart(data.data);
            } else if (data.type === 'temperature') {
                updateTemperatureChart(data.data);
            }
        });
        
        // Update dashboard with live data
        function updateDashboard(data) {
            const controller = data.controller || {};
            const monitor = data.monitor || {};
            
            // Update E-Stop status
            updateEstopStatus(controller.estop_active);
            
            // Update Engine status
            updateEngineStatus(controller.engine_running);
            
            // Update sequence state
            document.getElementById('sequenceState').textContent = controller.sequence_state || 'UNKNOWN';
            
            // Update system uptime
            const uptime = controller.uptime || 0;
            document.getElementById('systemUptime').textContent = formatUptime(uptime);
            
            // Update pressure values
            updatePressureGauges(controller.pressure_a1 || 0, controller.pressure_a5 || 0);
            
            // Update fuel information
            updateFuelDisplay(monitor.fuel_gallons || 0, monitor.fuel_pounds || 0, monitor.fuel_percent || 0);
            
            // Update temperature values
            document.getElementById('tempLocal').textContent = (monitor.temperature_local || 0).toFixed(1);
            document.getElementById('tempRemote').textContent = (monitor.temperature_remote || 0).toFixed(1);
            
            // Update timestamps
            const lastUpdate = new Date().toLocaleTimeString();
            console.log(`Dashboard updated at ${lastUpdate}`);
        }
        
        function updateEstopStatus(active) {
            const card = document.getElementById('estopCard');
            const icon = document.getElementById('estopIcon');
            const status = document.getElementById('estopStatus');
            
            if (active) {
                card.className = 'card status-card estop-active';
                icon.className = 'fas fa-hand-paper fa-3x mb-3';
                status.textContent = 'ðŸš¨ ACTIVE';
                showAlertTicker('E-STOP ACTIVATED - System Halted!');
            } else {
                card.className = 'card status-card status-ok';
                icon.className = 'fas fa-hand-paper fa-3x mb-3 text-success';
                status.textContent = 'âœ“ NORMAL';
                hideAlertTicker();
            }
        }
        
        function updateEngineStatus(running) {
            const card = document.getElementById('engineCard');
            const icon = document.getElementById('engineIcon');
            const status = document.getElementById('engineStatus');
            
            if (running) {
                card.className = 'card status-card engine-running';
                icon.className = 'fas fa-engine fa-3x mb-3';
                status.textContent = 'ðŸŸ¢ RUNNING';
            } else {
                card.className = 'card status-card engine-stopped';
                icon.className = 'fas fa-engine fa-3x mb-3';
                status.textContent = 'ðŸ›‘ STOPPED';
            }
        }
        
        function updatePressureGauges(a1Value, a5Value) {
            // Update gauge values
            document.getElementById('pressureA1Value').textContent = a1Value.toFixed(1);
            document.getElementById('pressureA5Value').textContent = a5Value.toFixed(1);
            
            // Create/update Plotly gauges
            const gaugeA1 = {
                type: "indicator",
                mode: "gauge+number",
                value: a1Value,
                title: { text: "PSI" },
                gauge: {
                    axis: { range: [null, 3000] },
                    bar: { color: "darkblue" },
                    steps: [
                        { range: [0, 1500], color: "lightgray" },
                        { range: [1500, 2500], color: "yellow" },
                        { range: [2500, 3000], color: "red" }
                    ],
                    threshold: {
                        line: { color: "red", width: 4 },
                        thickness: 0.75,
                        value: 2500
                    }
                }
            };
            
            const gaugeA5 = {
                type: "indicator",
                mode: "gauge+number",
                value: a5Value,
                title: { text: "PSI" },
                gauge: {
                    axis: { range: [null, 500] },
                    bar: { color: "darkorange" },
                    steps: [
                        { range: [0, 100], color: "lightgray" },
                        { range: [100, 300], color: "yellow" },
                        { range: [300, 500], color: "red" }
                    ],
                    threshold: {
                        line: { color: "red", width: 4 },
                        thickness: 0.75,
                        value: 300
                    }
                }
            };
            
            const layout = { width: 300, height: 250, margin: { t: 0, b: 0, l: 0, r: 0 } };
            
            Plotly.newPlot('pressureA1Gauge', [gaugeA1], layout, {displayModeBar: false});
            Plotly.newPlot('pressureA5Gauge', [gaugeA5], layout, {displayModeBar: false});
        }
        
        function updateFuelDisplay(gallons, pounds, percent) {
            document.getElementById('fuelGallons').textContent = gallons.toFixed(1);
            document.getElementById('fuelPercent').textContent = percent.toFixed(1) + '%';
            document.getElementById('fuelPounds').textContent = pounds.toFixed(0) + ' lbs';
            
            // Update visual fuel level
            const fuelLevel = document.getElementById('fuelLevel');
            fuelLevel.style.height = Math.min(100, Math.max(0, percent)) + '%';
            
            // Color coding based on fuel level
            if (percent < 25) {
                fuelLevel.style.background = 'linear-gradient(to top, #dc3545, #fd7e14)';
            } else if (percent < 50) {
                fuelLevel.style.background = 'linear-gradient(to top, #fd7e14, #ffc107)';
            } else {
                fuelLevel.style.background = 'linear-gradient(to top, #ff6b35, #f7931e, #ffc107)';
            }
        }
        
        function showAlertTicker(message) {
            const ticker = document.getElementById('alertTicker');
            const text = document.getElementById('alertText');
            text.textContent = message;
            ticker.style.display = 'block';
        }
        
        function hideAlertTicker() {
            const ticker = document.getElementById('alertTicker');
            ticker.style.display = 'none';
        }
        
        function showAlert(alert) {
            // Create toast notification
            const toast = document.createElement('div');
            toast.className = `alert alert-${alert.level === 'critical' ? 'danger' : 'warning'} position-fixed top-0 end-0 m-3`;
            toast.style.zIndex = '9999';
            toast.innerHTML = `
                <strong>${alert.level.toUpperCase()}:</strong> ${alert.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(toast);
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 10000);
        }
        
        function formatUptime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            } else if (minutes > 0) {
                return `${minutes}m ${secs}s`;
            } else {
                return `${secs}s`;
            }
        }
        
        function updateConnectionStatus(connected) {
            // Update UI to show connection status
            const navbar = document.querySelector('.navbar-brand');
            if (connected) {
                navbar.innerHTML = '<i class="fas fa-cogs text-success"></i> LogSplitter Control Dashboard';
            } else {
                navbar.innerHTML = '<i class="fas fa-cogs text-danger"></i> LogSplitter Control Dashboard (Disconnected)';
            }
        }
        
        // Chart loading functions
        function loadPressureChart(hours) {
            socket.emit('request_chart_data', { type: 'pressure', hours: hours });
        }
        
        function loadFuelChart(hours) {
            socket.emit('request_chart_data', { type: 'fuel', hours: hours });
        }
        
        function loadTemperatureChart(hours) {
            socket.emit('request_chart_data', { type: 'temperature', hours: hours });
        }
        
        function updatePressureChart(chartData) {
            if (chartData.error) {
                document.getElementById('pressureChart').innerHTML = `<p class="text-danger">Error: ${chartData.error}</p>`;
                return;
            }
            
            Plotly.newPlot('pressureChart', chartData.data, chartData.layout, {responsive: true});
        }
        
        function updateFuelChart(chartData) {
            if (chartData.error) {
                document.getElementById('fuelChart').innerHTML = `<p class="text-danger">Error: ${chartData.error}</p>`;
                return;
            }
            
            Plotly.newPlot('fuelChart', chartData.data, chartData.layout, {responsive: true});
        }
        
        function updateTemperatureChart(chartData) {
            if (chartData.error) {
                document.getElementById('temperatureChart').innerHTML = `<p class="text-danger">Error: ${chartData.error}</p>`;
                return;
            }
            
            Plotly.newPlot('temperatureChart', chartData.data, chartData.layout, {responsive: true});
        }
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Load initial charts
            loadPressureChart(6);
            loadFuelChart(24);
            loadTemperatureChart(6);
            
            // Set up auto-refresh
            setInterval(function() {
                // Refresh charts every 5 minutes
                loadPressureChart(6);
                loadFuelChart(24);
            }, 300000);
        });
    </script>
</body>
</html>